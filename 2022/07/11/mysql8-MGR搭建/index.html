

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Cper Liu">
  <meta name="keywords" content="">
  
    <meta name="description" content="mysql8 MGR搭建见18.2 Getting Started  1、环境准备   IP 主机名 数据库 端口 server-id 操作系统 备注    192.168.0.22 master1 mysql-8.0.17 3306 1 centos7.6-1810 master   192.168.0.23 master2 mysql-8.0.17 3306 2 centos7.6-1810">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql8 MGR搭建">
<meta property="og:url" content="http://example.com/2022/07/11/mysql8-MGR%E6%90%AD%E5%BB%BA/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="mysql8 MGR搭建见18.2 Getting Started  1、环境准备   IP 主机名 数据库 端口 server-id 操作系统 备注    192.168.0.22 master1 mysql-8.0.17 3306 1 centos7.6-1810 master   192.168.0.23 master2 mysql-8.0.17 3306 2 centos7.6-1810">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="c:/Users/liyupi/AppData/Roaming/Typora/typora-user-images/image-20201112114408736.png">
<meta property="og:image" content="c:/Users/liyupi/AppData/Roaming/Typora/typora-user-images/image-20201112161047218.png">
<meta property="article:published_time" content="2022-07-11T00:41:00.000Z">
<meta property="article:modified_time" content="2022-07-11T08:42:01.961Z">
<meta property="article:author" content="Cper Liu">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="c:/Users/liyupi/AppData/Roaming/Typora/typora-user-images/image-20201112114408736.png">
  
  
  
  <title>mysql8 MGR搭建 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="mysql8 MGR搭建"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-07-11 08:41" pubdate>
          2022年7月11日 早上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          23k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          192 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">mysql8 MGR搭建</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<h1 id="mysql8-MGR搭建"><a href="#mysql8-MGR搭建" class="headerlink" title="mysql8 MGR搭建"></a>mysql8 MGR搭建</h1><p>见<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-getting-started.html">18.2 Getting Started</a></p>
</blockquote>
<h4 id="1、环境准备"><a href="#1、环境准备" class="headerlink" title="1、环境准备"></a>1、环境准备</h4><table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>数据库</th>
<th>端口</th>
<th>server-id</th>
<th>操作系统</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.0.22</td>
<td>master1</td>
<td>mysql-8.0.17</td>
<td>3306</td>
<td>1</td>
<td>centos7.6-1810</td>
<td>master</td>
</tr>
<tr>
<td>192.168.0.23</td>
<td>master2</td>
<td>mysql-8.0.17</td>
<td>3306</td>
<td>2</td>
<td>centos7.6-1810</td>
<td>slave</td>
</tr>
<tr>
<td>192.168.0.24</td>
<td>master3</td>
<td>mysql-8.0.17</td>
<td>3306</td>
<td>3</td>
<td>centos7.6-1810</td>
<td>slave</td>
</tr>
</tbody></table>
<p>在3台服务器的&#x2F;etc&#x2F;hosts中加入以下配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markup">192.168.0.22 master1<br>192.168.0.23 master2<br>192.168.0.24 master3<br></code></pre></td></tr></table></figure>

<h4 id="2、安装MYSQL"><a href="#2、安装MYSQL" class="headerlink" title="2、安装MYSQL"></a>2、安装MYSQL</h4><p>安装方法见<a target="_blank" rel="noopener" href="http://wiki.ghostcloud.cn/pages/viewpage.action?pageId=21333870">http://wiki.ghostcloud.cn/pages/viewpage.action?pageId=21333870</a></p>
<h4 id="3、安装MGR插件"><a href="#3、安装MGR插件" class="headerlink" title="3、安装MGR插件"></a>3、安装MGR插件</h4><p>三台服务器都要装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 登录mysql</span><br>mysql -uroot -p<br><br><span class="hljs-comment"># 安装插件</span><br>install PLUGIN group_replication SONAME <span class="hljs-string">&#x27;group_replication.so&#x27;</span>;<br><br><span class="hljs-comment"># 查看group replication插件</span><br>show plugins;<br><br></code></pre></td></tr></table></figure>

<p>安装完后如下图所示<br><img src="C:\Users\liyupi\AppData\Roaming\Typora\typora-user-images\image-20201112114408736.png" srcset="/img/loading.gif" lazyload alt="image-20201112114408736"></p>
<h4 id="4、配置复制环境，见官方文档18-2-1-2-Configuring-an-Instance-for-Group-Replication"><a href="#4、配置复制环境，见官方文档18-2-1-2-Configuring-an-Instance-for-Group-Replication" class="headerlink" title="4、配置复制环境，见官方文档18.2.1.2 Configuring an Instance for Group Replication"></a>4、配置复制环境，见官方文档<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-configuring-instances.html">18.2.1.2 Configuring an Instance for Group Replication</a></h4><h6 id="4-1、配置192-168-0-22（master1）"><a href="#4-1、配置192-168-0-22（master1）" class="headerlink" title="4.1、配置192.168.0.22（master1）"></a>4.1、配置192.168.0.22（master1）</h6><p><strong>打开&#x2F;etc&#x2F;mysql&#x2F;my.cnf，添加以下配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[mysqld]<br><span class="hljs-comment"># Group Replication</span><br>server-id=5<br>slow_query_log=1<br>log_queries_not_using_indexes=1<br>slow_query_log_file=/var/log/mysql/slow-query.log<br>log-bin=/var/log/mysql/mgr-bin<br>relay-log=/var/log/mysql/mgr-relay<br>character_set_server=utf8mb4<br><br><span class="hljs-comment"># MGR使用乐观锁，所以官网建议隔离级别是RC，减少锁粒度</span><br>transaction_isolation=READ-COMMITTED<br>gtid_mode=on<br>enforce_gtid_consistency=1 <span class="hljs-comment"># 强制GTID一致性</span><br>binlog_format=row<br><br><span class="hljs-comment"># 因为集群会在故障恢复时互相检查binlog的数据,所以需要记录下集群内其他服务器发过来已经执行过的binlog,按GTID来区分是否执行过.</span><br>log-slave-updates=1<br><br><span class="hljs-comment"># binlog校验规则，5.6之后的高版本是CRC32，低版本都是NONE，但是MGR要求使用NONE</span><br>binlog_checksum=NONE<br><br><span class="hljs-comment"># 基于安全的考虑，MGR集群要求复制模式要改成slave记录记录到表中，不然就报错</span><br>master_info_repository=TABLE<br>relay_log_info_repository=TABLE<br><br><span class="hljs-comment"># 记录事务的算法,官网建议设置该参数使用 XXHASH64 算法</span><br>transaction_write_set_extraction = XXHASH64<br><br><span class="hljs-comment"># 加载group_replication插件</span><br>plugin_load_add=<span class="hljs-string">&#x27;group_replication.so&#x27;</span><br><br><span class="hljs-comment"># 相当于此GROUP的名字，是UUID值，可以使用select uuid()生成</span><br>group_replication_group_name = <span class="hljs-string">&#x27;558edd3c-02ec-11ea-9bb3-080027e39bd2&#x27;</span><br><br><span class="hljs-comment"># 是否随服务器启动而自动启动组复制，不建议直接启动，怕故障恢复时有扰乱数据准确性的特殊情况</span><br>group_replication_start_on_boot = OFF<br><br><span class="hljs-comment"># 本地MGR的IP地址和端口，host:port,是MGR的端口,不是数据库的端口</span><br>group_replication_local_address = <span class="hljs-string">&#x27;master1:33061&#x27;</span><br><br><span class="hljs-comment"># 需要接受本MGR实例控制的服务器IP地址和端口，是MGR的端口，不是数据库的端口</span><br>group_replication_group_seeds = <span class="hljs-string">&#x27;master1:33061,master2:33061,master3:33061&#x27;</span><br><br><span class="hljs-comment"># 开启引导模式，添加组成员，用于第一次搭建MGR或重建MGR的时候使用，只需要在集群内的其中一台开启</span><br>group_replication_bootstrap_group = OFF<br></code></pre></td></tr></table></figure>

<p><strong>重启mysql，命令<code>service mysql restart</code></strong></p>
<p><strong>建立复制账号并启动group replication</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 登录mysql</span><br>mysql -uroot -p<br><span class="hljs-built_in">export</span> MYSQL_PWD=aL3ec1LW@2<br><span class="hljs-comment"># 关闭日志记录</span><br>mysql -e <span class="hljs-string">&quot;set SQL_LOG_BIN=0;&quot;</span><br><br><br><span class="hljs-comment"># 创建用户（远程可以访问）</span><br>mysql -e <span class="hljs-string">&quot;create user &#x27;MGR&#x27;@&#x27;%&#x27; identified by &#x27;4fYTvCU%92&#x27;;&quot;</span><br><br><span class="hljs-comment"># 授权</span><br>mysql -e <span class="hljs-string">&quot;grant replication slave on *.* to MGR@&#x27;%&#x27; ;&quot;</span><br><span class="hljs-comment"># 修改加密规则</span><br>ALTER USER <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;password&#x27;</span> PASSWORD EXPIRE NEVER; <br><br>mysql -e <span class="hljs-string">&quot;ALTER USER &#x27;MGR&#x27;@&#x27;%&#x27; identified by &#x27;4fYTvCU%92&#x27; PASSWORD EXPIRE NEVER;&quot;</span><br><span class="hljs-comment"># 更新一下用户的密码 </span><br>mysql -e <span class="hljs-string">&quot;ALTER USER &#x27;MGR&#x27;@&#x27;%&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;4fYTvCU%92&#x27;;&quot;</span><br><span class="hljs-comment"># 刷新权限</span><br>mysql -e <span class="hljs-string">&quot;flush privileges;&quot;</span><br><br><br><span class="hljs-comment"># 开启日志</span><br>mysql -e <span class="hljs-string">&quot;set SQL_LOG_BIN=1;&quot;</span><br><br><span class="hljs-comment"># 构建group replication集群</span><br>mysql -e <span class="hljs-string">&quot;change master to master_user=&#x27;MGR&#x27;,master_password=&#x27;4fYTvCU%92&#x27; for channel &#x27;group_replication_recovery&#x27;;&quot;</span><br><br><br><span class="hljs-comment"># 设置group_replication_bootstrap_group为ON是为了标示以后加入集群的服务器以这台服务器为基准，以后加入的就不需要设置</span><br>mysql -e  <span class="hljs-string">&quot;set global group_replication_bootstrap_group=ON;&quot;</span><br><br><span class="hljs-comment"># 作为首个节点启动MGR集群</span><br>mysql -e  <span class="hljs-string">&quot;start group_replication;&quot;</span><br><br><span class="hljs-comment"># 关闭group_replication_bootstrap_group</span><br>mysql -e  <span class="hljs-string">&quot;set global group_replication_bootstrap_group=OFF;&quot;</span><br><br><span class="hljs-comment"># 查看mgr的状态，查询表performance_schema.replication_group_members</span><br> mysql -e <span class="hljs-string">&quot;select * from performance_schema.replication_group_members;&quot;</span><br><br><span class="hljs-comment"># group相关参数查看</span><br>mysql -e <span class="hljs-string">&quot;show variables like &#x27;group%&#x27;;&quot;</span><br></code></pre></td></tr></table></figure>

<h6 id="4-2、配置192-168-0-23（master2）"><a href="#4-2、配置192-168-0-23（master2）" class="headerlink" title="4.2、配置192.168.0.23（master2）"></a>4.2、配置192.168.0.23（master2）</h6><p>复制master1的配置文件&#x2F;etc&#x2F;mysql&#x2F;my.cnf，修改server_id，loose-group_replication_local_address即可，如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">[mysqld]<br><span class="hljs-comment"># Group Replication</span><br>server-id=2<br>slow_query_log=1<br>log_queries_not_using_indexes=1<br>slow_query_log_file=/var/log/mysql/slow-query.log<br>log-bin=/var/log/mysql/mgr-bin<br>relay-log=/var/log/mysql/mgr-relay<br>character_set_server=utf8mb4<br><br><span class="hljs-comment"># MGR使用乐观锁，所以官网建议隔离级别是RC，减少锁粒度</span><br>transaction_isolation=READ-COMMITTED<br>gtid_mode=on<br>enforce_gtid_consistency=1 <span class="hljs-comment"># 强制GTID一致性</span><br>binlog_format=row<br><br><span class="hljs-comment"># 因为集群会在故障恢复时互相检查binlog的数据,所以需要记录下集群内其他服务器发过来已经执行过的binlog,按GTID来区分是否执行过.</span><br>log-slave-updates=1<br><br><span class="hljs-comment"># binlog校验规则，5.6之后的高版本是CRC32，低版本都是NONE，但是MGR要求使用NONE</span><br>binlog_checksum=NONE<br><br><span class="hljs-comment"># 基于安全的考虑，MGR集群要求复制模式要改成slave记录记录到表中，不然就报错</span><br>master_info_repository=TABLE<br>relay_log_info_repository=TABLE<br><br><span class="hljs-comment"># 记录事务的算法,官网建议设置该参数使用 XXHASH64 算法</span><br>transaction_write_set_extraction = XXHASH64<br><br><span class="hljs-comment"># 启动时加载group_replication插件</span><br>plugin_load_add=<span class="hljs-string">&#x27;group_replication.so&#x27;</span><br><br><span class="hljs-comment"># 相当于此GROUP的名字，是UUID值，可以使用select uuid()生成</span><br>group_replication_group_name = <span class="hljs-string">&#x27;558edd3c-02ec-11ea-9bb3-080027e39bd2&#x27;</span><br><br><span class="hljs-comment"># 是否随服务器启动而自动启动组复制，不建议直接启动，怕故障恢复时有扰乱数据准确性的特殊情况</span><br>group_replication_start_on_boot = OFF<br><br><span class="hljs-comment"># 本地MGR的IP地址和端口，host:port,是MGR的端口,不是数据库的端口</span><br>group_replication_local_address = <span class="hljs-string">&#x27;master2:33061&#x27;</span><br><br><span class="hljs-comment"># 需要接受本MGR实例控制的服务器IP地址和端口，是MGR的端口，不是数据库的端口</span><br>group_replication_group_seeds = <span class="hljs-string">&#x27;master1:33061,master2:33061,master3:33061&#x27;</span><br><br><span class="hljs-comment"># 开启引导模式，添加组成员，用于第一次搭建MGR或重建MGR的时候使用，只需要在集群内的其中一台开启</span><br>group_replication_bootstrap_group = OFF<br></code></pre></td></tr></table></figure>

<p><strong>重启mysql，命令<code>service mysql restart</code></strong></p>
<p><strong>建立复制账号并启动group replication</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 配置 MYSQL_PWD<br>export MYSQL_PWD<span class="hljs-operator">=</span>aL3ec1LW<span class="hljs-variable">@2</span><br><br># 关闭日志记录<br>mysql <span class="hljs-operator">-</span>e &quot;set SQL_LOG_BIN=0;&quot;<br><br># 创建用户（网段<span class="hljs-number">192.168</span><span class="hljs-number">.50</span>的可以访问）<br>mysql <span class="hljs-operator">-</span>e &quot;create user &#x27;MGR&#x27;@&#x27;%&#x27; identified by &#x27;4fYTvCU%92&#x27;;&quot;<br># 授权<br>mysql <span class="hljs-operator">-</span>e &quot;grant replication slave on *.* to MGR@&#x27;%&#x27; ;&quot;<br># 刷新权限<br>mysql <span class="hljs-operator">-</span>e &quot;flush privileges;&quot;<br># 开启日志<br>mysql <span class="hljs-operator">-</span>e &quot;set SQL_LOG_BIN=1;&quot;<br><br># 构建<span class="hljs-keyword">group</span> replication集群<br>mysql <span class="hljs-operator">-</span>e &quot;change master to master_user=&#x27;MGR&#x27;,master_password=&#x27;4fYTvCU%92&#x27; for channel &#x27;group_replication_recovery&#x27;;&quot;<br><br># 加入MGR集群<br>mysql <span class="hljs-operator">-</span>e &quot;set global group_replication_allow_local_disjoint_gtids_join=ON;&quot;<br>mysql <span class="hljs-operator">-</span>e &quot;start group_replication;&quot;<br><br># 查看mgr的状态，查询表performance_schema.replication_group_members，发现已加入MGR群<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> performance_schema.replication_group_members;<br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="hljs-operator">|</span> CHANNEL_NAME              <span class="hljs-operator">|</span> MEMBER_ID                            <span class="hljs-operator">|</span> MEMBER_HOST <span class="hljs-operator">|</span> MEMBER_PORT <span class="hljs-operator">|</span> MEMBER_STATE <span class="hljs-operator">|</span> MEMBER_ROLE <span class="hljs-operator">|</span> MEMBER_VERSION <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="hljs-operator">|</span> group_replication_applier <span class="hljs-operator">|</span> <span class="hljs-number">4</span>c668095<span class="hljs-operator">-</span>dd20<span class="hljs-number">-11e9</span><span class="hljs-number">-95</span>ba<span class="hljs-number">-080027e39</span>bc3 <span class="hljs-operator">|</span> master2    <span class="hljs-operator">|</span>        <span class="hljs-number">3306</span> <span class="hljs-operator">|</span> RECOVERING   <span class="hljs-operator">|</span> SECONDARY   <span class="hljs-operator">|</span> <span class="hljs-number">8.0</span><span class="hljs-number">.17</span>         <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> group_replication_applier <span class="hljs-operator">|</span> <span class="hljs-number">4</span>c668095<span class="hljs-operator">-</span>dd20<span class="hljs-number">-11e9</span><span class="hljs-number">-95</span>ba<span class="hljs-number">-080027e39</span>bd2 <span class="hljs-operator">|</span> master1    <span class="hljs-operator">|</span>        <span class="hljs-number">3306</span> <span class="hljs-operator">|</span> ONLINE       <span class="hljs-operator">|</span> <span class="hljs-keyword">PRIMARY</span>     <span class="hljs-operator">|</span> <span class="hljs-number">8.0</span><span class="hljs-number">.17</span>         <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="hljs-number">1234567891011121314151617181920212223242526272829303132</span><br></code></pre></td></tr></table></figure>

<p>节点长时间处于RECOVERING状态，见下面第6.1节，有解决方法</p>
<h6 id="4-3、配置192-168-0-24（master3）"><a href="#4-3、配置192-168-0-24（master3）" class="headerlink" title="4.3、配置192.168.0.24（master3）"></a>4.3、配置192.168.0.24（master3）</h6><p>复制master1的配置文件&#x2F;etc&#x2F;mysql&#x2F;my.cnf，修改server_id，loose-group_replication_local_address即可，如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs bash">[mysqld]<br><span class="hljs-comment"># Group Replication</span><br>server-id=7<br>slow_query_log=1<br>log_queries_not_using_indexes=1<br>slow_query_log_file=/var/log/mysql/slow-query.log<br>log-bin=/var/log/mysql/mgr-bin<br>relay-log=/var/log/mysql/mgr-relay<br>character_set_server=utf8mb4<br><br><span class="hljs-comment"># MGR使用乐观锁，所以官网建议隔离级别是RC，减少锁粒度</span><br>transaction_isolation=READ-COMMITTED<br>gtid_mode=on<br>enforce_gtid_consistency=1 <span class="hljs-comment"># 强制GTID一致性</span><br>binlog_format=row<br><br><span class="hljs-comment"># 因为集群会在故障恢复时互相检查binlog的数据,所以需要记录下集群内其他服务器发过来已经执行过的binlog,按GTID来区分是否执行过.</span><br>log-slave-updates=1<br><br><span class="hljs-comment"># binlog校验规则，5.6之后的高版本是CRC32，低版本都是NONE，但是MGR要求使用NONE</span><br>binlog_checksum=NONE<br><br><span class="hljs-comment"># 基于安全的考虑，MGR集群要求复制模式要改成slave记录记录到表中，不然就报错</span><br>master_info_repository=TABLE<br>relay_log_info_repository=TABLE<br><br><span class="hljs-comment"># 记录事务的算法,官网建议设置该参数使用 XXHASH64 算法</span><br>transaction_write_set_extraction = XXHASH64<br><br><span class="hljs-comment"># 启动时加载group_replication插件</span><br>plugin_load_add=<span class="hljs-string">&#x27;group_replication.so&#x27;</span><br><br><span class="hljs-comment"># 相当于此GROUP的名字，是UUID值，可以使用select uuid()生成</span><br>group_replication_group_name = <span class="hljs-string">&#x27;558edd3c-02ec-11ea-9bb3-080027e39bd2&#x27;</span><br><br><span class="hljs-comment"># 是否随服务器启动而自动启动组复制，不建议直接启动，怕故障恢复时有扰乱数据准确性的特殊情况</span><br>group_replication_start_on_boot = OFF<br><br><span class="hljs-comment"># 本地MGR的IP地址和端口，host:port,是MGR的端口,不是数据库的端口</span><br>group_replication_local_address = <span class="hljs-string">&#x27;master3:33061&#x27;</span><br><br><span class="hljs-comment"># 需要接受本MGR实例控制的服务器IP地址和端口，是MGR的端口，不是数据库的端口</span><br>group_replication_group_seeds = <span class="hljs-string">&#x27;master1:33061,master2:33061,master3:33061&#x27;</span><br><br><span class="hljs-comment"># 开启引导模式，添加组成员，用于第一次搭建MGR或重建MGR的时候使用，只需要在集群内的其中一台开启</span><br>group_replication_bootstrap_group = OFF<br>12345678910111213141516171819202122232425262728293031323334353637383940414243444546<br></code></pre></td></tr></table></figure>

<p><strong>重启mysql，命令<code>service mysql restart</code></strong></p>
<p><strong>建立复制账号并启动group replication</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 登录mysql<br>mysql <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>p<br><br># 关闭日志记录<br><span class="hljs-keyword">set</span> SQL_LOG_BIN<span class="hljs-operator">=</span><span class="hljs-number">0</span>;<br><br># 创建用户（网段<span class="hljs-number">192.168</span><span class="hljs-number">.50</span>的可以访问）<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;mgr_repl&#x27;</span>@<span class="hljs-string">&#x27;192.168.50.%&#x27;</span> IDENTIFIED <span class="hljs-keyword">WITH</span> sha256_password <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;123456&#x27;</span>;<br><br># 授权<br><span class="hljs-keyword">GRANT</span> REPLICATION SLAVE <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;mgr_repl&#x27;</span>@<span class="hljs-string">&#x27;192.168.50.%&#x27;</span>;<br><br># 刷新权限<br>flush privileges;<br><br># 开启日志<br><span class="hljs-keyword">set</span> SQL_LOG_BIN<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br><br># 构建<span class="hljs-keyword">group</span> replication集群<br>change master <span class="hljs-keyword">to</span> master_user<span class="hljs-operator">=</span><span class="hljs-string">&#x27;mgr_repl&#x27;</span>,master_password<span class="hljs-operator">=</span><span class="hljs-string">&#x27;123456&#x27;</span> <span class="hljs-keyword">for</span> channel <span class="hljs-string">&#x27;group_replication_recovery&#x27;</span>;<br><br># 加入MGR集群<br><span class="hljs-keyword">start</span> group_replication;<br><br># 查看mgr的状态，查询表performance_schema.replication_group_members，发现已加入MGR群<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> performance_schema.replication_group_members;<br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="hljs-operator">|</span> CHANNEL_NAME              <span class="hljs-operator">|</span> MEMBER_ID                            <span class="hljs-operator">|</span> MEMBER_HOST <span class="hljs-operator">|</span> MEMBER_PORT <span class="hljs-operator">|</span> MEMBER_STATE <span class="hljs-operator">|</span> MEMBER_ROLE <span class="hljs-operator">|</span> MEMBER_VERSION <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="hljs-operator">|</span> group_replication_applier <span class="hljs-operator">|</span> <span class="hljs-number">4</span>c668095<span class="hljs-operator">-</span>dd20<span class="hljs-number">-11e9</span><span class="hljs-number">-95</span>ba<span class="hljs-number">-080027e39</span>bc3 <span class="hljs-operator">|</span> master2    <span class="hljs-operator">|</span>        <span class="hljs-number">3306</span> <span class="hljs-operator">|</span> ONLINE       <span class="hljs-operator">|</span> SECONDARY   <span class="hljs-operator">|</span> <span class="hljs-number">8.0</span><span class="hljs-number">.17</span>         <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> group_replication_applier <span class="hljs-operator">|</span> <span class="hljs-number">4</span>c668095<span class="hljs-operator">-</span>dd20<span class="hljs-number">-11e9</span><span class="hljs-number">-95</span>ba<span class="hljs-number">-080027e39</span>bd2 <span class="hljs-operator">|</span> master1    <span class="hljs-operator">|</span>        <span class="hljs-number">3306</span> <span class="hljs-operator">|</span> ONLINE       <span class="hljs-operator">|</span> <span class="hljs-keyword">PRIMARY</span>     <span class="hljs-operator">|</span> <span class="hljs-number">8.0</span><span class="hljs-number">.17</span>         <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> group_replication_applier <span class="hljs-operator">|</span> c90e9166<span class="hljs-operator">-</span>de11<span class="hljs-number">-11e9</span><span class="hljs-number">-9</span>ee0<span class="hljs-number">-080027</span>d8da86 <span class="hljs-operator">|</span> master3    <span class="hljs-operator">|</span>        <span class="hljs-number">3306</span> <span class="hljs-operator">|</span> ONLINE       <span class="hljs-operator">|</span> SECONDARY   <span class="hljs-operator">|</span> <span class="hljs-number">8.0</span><span class="hljs-number">.17</span>         <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><br></code></pre></td></tr></table></figure>

<h4 id="5、测试"><a href="#5、测试" class="headerlink" title="5、测试"></a>5、测试</h4><p>在master1（192.168.0.22）上执行以下sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 测试master1上的mysql<br><span class="hljs-keyword">create</span> database repl;<br>use repl;<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> test (id <span class="hljs-type">int</span> <span class="hljs-keyword">primary</span> key, name <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>));  #注意创建主键<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> test <span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;测试&#x27;</span>);<br><br># 查看binlog<br><span class="hljs-keyword">SHOW</span> BINLOG EVENTS;<br><br><br></code></pre></td></tr></table></figure>

<p>查看master1的结果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> test;<br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> name   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------+</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">1</span> <span class="hljs-operator">|</span> 测试   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------+</span><br><br><br></code></pre></td></tr></table></figure>

<p>查看master2的结果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sql"># repl数据库已同步过来了<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> databases;<br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------+</span><br><span class="hljs-operator">|</span> Database           <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------+</span><br><span class="hljs-operator">|</span> information_schema <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> mybatis            <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> mysql              <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> performance_schema <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> repl               <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> sys                <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------+</span><br>mysql<span class="hljs-operator">&gt;</span> use repl;<br>Reading <span class="hljs-keyword">table</span> information <span class="hljs-keyword">for</span> completion <span class="hljs-keyword">of</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">column</span> names<br>You can turn off this feature <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> a quicker startup <span class="hljs-keyword">with</span> <span class="hljs-operator">-</span>A<br><br>Database changed<br><br><span class="hljs-comment">-- 数据也同步过来了</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> test;<br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> name   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------+</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">1</span> <span class="hljs-operator">|</span> 测试   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------+</span><br><br></code></pre></td></tr></table></figure>

<p>查看master3的结果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sql"># repl数据库已同步过来了<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> databases;<br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------+</span><br><span class="hljs-operator">|</span> Database           <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------+</span><br><span class="hljs-operator">|</span> information_schema <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> mybatis            <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> mysql              <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> performance_schema <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> repl               <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> sys                <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------+</span><br>mysql<span class="hljs-operator">&gt;</span> use repl;<br>Reading <span class="hljs-keyword">table</span> information <span class="hljs-keyword">for</span> completion <span class="hljs-keyword">of</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">column</span> names<br>You can turn off this feature <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> a quicker startup <span class="hljs-keyword">with</span> <span class="hljs-operator">-</span>A<br><br>Database changed<br><br><span class="hljs-comment">-- 数据也同步过来了</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> test;<br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> name   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------+</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">1</span> <span class="hljs-operator">|</span> 测试   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------+</span><br><br></code></pre></td></tr></table></figure>

<h6 id="因为是单主模式，master1为主（PRIMARY），支持读写，master2和master3为从（SECONDARY），只支持读，如果执行写会失败，如下"><a href="#因为是单主模式，master1为主（PRIMARY），支持读写，master2和master3为从（SECONDARY），只支持读，如果执行写会失败，如下" class="headerlink" title="因为是单主模式，master1为主（PRIMARY），支持读写，master2和master3为从（SECONDARY），只支持读，如果执行写会失败，如下"></a>因为是单主模式，master1为主（PRIMARY），支持读写，master2和master3为从（SECONDARY），只支持读，如果执行写会失败，如下</h6><p>在master2和master3中执行<code>insert into test values (2,&#39;写入测试&#39;);</code>，都会报以下错误</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> test <span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;写入测试&#x27;</span>);<br>ERROR <span class="hljs-number">1290</span> (HY000): The MySQL server <span class="hljs-keyword">is</span> <span class="hljs-keyword">running</span> <span class="hljs-keyword">with</span> the <span class="hljs-comment">--super-read-only option so it cannot execute this statement</span><br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure>

<p>在master1执行则成功</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> test <span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;写入测试&#x27;</span>);<br>Query OK, <span class="hljs-number">1</span> <span class="hljs-type">row</span> affected (<span class="hljs-number">0.11</span> sec)<br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure>

<h4 id="6、常见的错误"><a href="#6、常见的错误" class="headerlink" title="6、常见的错误"></a>6、常见的错误</h4><h5 id="6-1-节点长期处于RECOVERING状态的解决方法"><a href="#6-1-节点长期处于RECOVERING状态的解决方法" class="headerlink" title="6.1 节点长期处于RECOVERING状态的解决方法"></a><code>6.1 节点长期处于RECOVERING状态的解决方法</code></h5><p>查看日志，发现是用户密码加密插件问题<code>Authentication plugin &#39;caching_sha2_password&#39; reported error: Authentication requires secure connection.</code>，也就是创建复制用户时，密码默认是mysql 8的加密方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">2019-11-09T14:59:18.932184Z 28 [ERROR] [MY-011583] [Repl] Plugin group_replication reported: <span class="hljs-string">&#x27;For details please check performance_schema.replication_connection_status table and error log messages of Slave I/O for channel group_replication_recovery.&#x27;</span><br>2019-11-09T15:00:19.061955Z 28 [System] [MY-010597] [Repl] <span class="hljs-string">&#x27;CHANGE MASTER TO FOR CHANNEL &#x27;</span>group_replication_recovery<span class="hljs-string">&#x27; executed&#x27;</span>. Previous state master_host=<span class="hljs-string">&#x27;master1&#x27;</span>, master_port= 3306, master_log_file=<span class="hljs-string">&#x27;&#x27;</span>, master_log_pos= 4, master_bind=<span class="hljs-string">&#x27;&#x27;</span>. New state master_host=<span class="hljs-string">&#x27;master1&#x27;</span>, master_port= 3306, master_log_file=<span class="hljs-string">&#x27;&#x27;</span>, master_log_pos= 4, master_bind=<span class="hljs-string">&#x27;&#x27;</span>.<br>2019-11-09T15:00:19.144499Z 37 [Warning] [MY-010897] [Repl] Storing MySQL user name or password information <span class="hljs-keyword">in</span> the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options <span class="hljs-keyword">for</span> START SLAVE; see the <span class="hljs-string">&#x27;START SLAVE Syntax&#x27;</span> <span class="hljs-keyword">in</span> the MySQL Manual <span class="hljs-keyword">for</span> more information.<br>2019-11-09T15:00:19.154364Z 37 [ERROR] [MY-010584] [Repl] Slave I/O <span class="hljs-keyword">for</span> channel <span class="hljs-string">&#x27;group_replication_recovery&#x27;</span>: error connecting to master <span class="hljs-string">&#x27;mgr_repl@master1:3306&#x27;</span> - retry-time: 60 retries: 1 message: Authentication plugin <span class="hljs-string">&#x27;caching_sha2_password&#x27;</span> reported error: Authentication requires secure connection. Error_code: MY-002061<br>2019-11-09T15:00:19.196600Z 28 [ERROR] [MY-011582] [Repl] Plugin group_replication reported: <span class="hljs-string">&#x27;There was an error when connecting to the donor server. Please check that group_replication_recovery channel credentials and all MEMBER_HOST column values of performance_schema.replication_group_members table are correct and DNS resolvable.&#x27;</span><br>2019-11-09T15:00:19.196632Z 28 [ERROR] [MY-011583] [Repl] Plugin group_replication reported: <span class="hljs-string">&#x27;For details please check performance_schema.replication_connection_status table and error log messages of Slave I/O for channel group_replication_recovery.&#x27;</span><br>123456<br></code></pre></td></tr></table></figure>

<p>解决方法，更改密码加密方式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SET</span> SQL_LOG_BIN<span class="hljs-operator">=</span><span class="hljs-number">0</span>;<br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;mgr_repl&#x27;</span>@<span class="hljs-string">&#x27;192.168.50.%&#x27;</span> IDENTIFIED <span class="hljs-keyword">WITH</span> sha256_password <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;123456&#x27;</span>;<br><span class="hljs-keyword">GRANT</span> REPLICATION SLAVE <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;mgr_repl&#x27;</span>@<span class="hljs-string">&#x27;192.168.50.%&#x27;</span>;<br><span class="hljs-keyword">SET</span> SQL_LOG_BIN<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br><span class="hljs-number">1234</span><br></code></pre></td></tr></table></figure>

<p>再启动MGR就可以正常了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> performance_schema.replication_group_members;<br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="hljs-operator">|</span> CHANNEL_NAME              <span class="hljs-operator">|</span> MEMBER_ID                            <span class="hljs-operator">|</span> MEMBER_HOST <span class="hljs-operator">|</span> MEMBER_PORT <span class="hljs-operator">|</span> MEMBER_STATE <span class="hljs-operator">|</span> MEMBER_ROLE <span class="hljs-operator">|</span> MEMBER_VERSION <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="hljs-operator">|</span> group_replication_applier <span class="hljs-operator">|</span> <span class="hljs-number">4</span>c668095<span class="hljs-operator">-</span>dd20<span class="hljs-number">-11e9</span><span class="hljs-number">-95</span>ba<span class="hljs-number">-080027e39</span>bc3 <span class="hljs-operator">|</span> master2    <span class="hljs-operator">|</span>        <span class="hljs-number">3306</span> <span class="hljs-operator">|</span> ONLINE       <span class="hljs-operator">|</span> SECONDARY   <span class="hljs-operator">|</span> <span class="hljs-number">8.0</span><span class="hljs-number">.17</span>         <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> group_replication_applier <span class="hljs-operator">|</span> <span class="hljs-number">4</span>c668095<span class="hljs-operator">-</span>dd20<span class="hljs-number">-11e9</span><span class="hljs-number">-95</span>ba<span class="hljs-number">-080027e39</span>bd2 <span class="hljs-operator">|</span> master1    <span class="hljs-operator">|</span>        <span class="hljs-number">3306</span> <span class="hljs-operator">|</span> ONLINE       <span class="hljs-operator">|</span> <span class="hljs-keyword">PRIMARY</span>     <span class="hljs-operator">|</span> <span class="hljs-number">8.0</span><span class="hljs-number">.17</span>         <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="hljs-number">1234567</span><br></code></pre></td></tr></table></figure>



<p>6.2 其他节点执行start group_replication报错，查看日志如下</p>
<p><img src="C:\Users\liyupi\AppData\Roaming\Typora\typora-user-images\image-20201112161047218.png" srcset="/img/loading.gif" lazyload alt="image-20201112161047218"></p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[ERROR] [MY<span class="hljs-string">-011526</span>] [Repl] Plugin group_replication reported: &#x27;This member has more executed transactions than those present in the group. Local transactions: cd6c626d<span class="hljs-string">-248</span>e<span class="hljs-string">-11</span>eb<span class="hljs-string">-8</span>f23<span class="hljs-string">-00155</span>d020983:1<span class="hljs-string">-2</span> &gt; Group transactions: 558edd3c<span class="hljs-string">-02</span>ec<span class="hljs-string">-11</span>ea<span class="hljs-string">-9</span>bb3<span class="hljs-string">-080027</span>e39bd2:1<span class="hljs-string">-16</span>, dfee2d85<span class="hljs-string">-2497</span><span class="hljs-string">-11</span>eb-ab7e<span class="hljs-string">-00155</span>d020982:1<span class="hljs-string">-3</span>&#x27;<br></code></pre></td></tr></table></figure>


<p>原因是在这个节点有操作了之前创建了用户因为是初始化安装所以可以 reset master 清空Executed_Gtid_Set</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">mysql</span> -e  <span class="hljs-string">&quot; reset master;&quot;</span><br>mysql -e  <span class="hljs-string">&quot;start group_replication;&quot;</span><br><br><br></code></pre></td></tr></table></figure>



<h4 id="7、管理维护"><a href="#7、管理维护" class="headerlink" title="7、管理维护"></a>7、管理维护</h4><h5 id="7-1-单主切换到多主"><a href="#7-1-单主切换到多主" class="headerlink" title="7.1 单主切换到多主"></a>7.1 单主切换到多主</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># MGR切换模式需要重新启动组复制，因此需要在所有节点上先关闭组复制，</span><br><span class="hljs-comment"># 设置 group_replication_single_primary_mode=OFF 等参数，再启动组复制。</span><br><span class="hljs-comment"># 停止组复制(在所有MGR节点上执行)：</span><br>stop group_replication;<br><br><span class="hljs-comment"># 单主模式关闭</span><br><span class="hljs-built_in">set</span> global group_replication_single_primary_mode=OFF;<br><br><span class="hljs-comment"># 如果是单主模式,因为不存在多主同时操作的可能,这个强制检查是可以关闭,因为已经不存在这样的操作,多主是必须要开的,不开的话数据就可能出现错乱了</span><br><span class="hljs-built_in">set</span> global group_replication_enforce_update_everywhere_checks=ON;<br><br><span class="hljs-comment"># 随便选择某个MGR节点执行 (比如这里选择在master1节点):</span><br><span class="hljs-built_in">set</span> global group_replication_recovery_get_public_key=1;<br>SET GLOBAL group_replication_bootstrap_group=ON;<br>START GROUP_REPLICATION;<br>SET GLOBAL group_replication_bootstrap_group=OFF;<br><br><span class="hljs-comment"># 然后在其他的MGR节点执行 (这里指master2和master3节点上执行):</span><br><span class="hljs-built_in">set</span> global group_replication_recovery_get_public_key=1;<br>START GROUP_REPLICATION;<br><br><span class="hljs-comment"># 查看MGR组信息 (在任意一个MGR节点上都可以查看)</span><br>SELECT * FROM performance_schema.replication_group_members;<br>1234567891011121314151617181920212223<br><br></code></pre></td></tr></table></figure>

<h5 id="7-2-多主切换回单主"><a href="#7-2-多主切换回单主" class="headerlink" title="7.2 多主切换回单主"></a>7.2 多主切换回单主</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 停止组复制(在所有MGR节点上执行)：</span><br>stop group_replication;<br><br><span class="hljs-comment"># 如果是单主模式,因为不存在多主同时操作的可能,这个强制检查是可以关闭,因为已经不存在这样的操作,多主是必须要开的,不开的话数据就可能出现错乱了</span><br><span class="hljs-built_in">set</span> global group_replication_enforce_update_everywhere_checks=OFF;<br><br><span class="hljs-comment"># 打开单主模式</span><br><span class="hljs-built_in">set</span> global group_replication_single_primary_mode=ON;<br><br><span class="hljs-comment"># 选择一个节点作为主节点, 在主节点上执行 (这里选择master1节点作为主节点)</span><br>SET GLOBAL group_replication_bootstrap_group=ON;<br>START GROUP_REPLICATION;<br>SET GLOBAL group_replication_bootstrap_group=OFF;<br> <br><span class="hljs-comment"># 在其他剩余的节点, 也就是从库节点上执行 (这里从库节点指的就是master2和master3):</span><br>START GROUP_REPLICATION;<br><br><span class="hljs-comment"># 查看MGR组信息 (在任意一个MGR节点上都可以查看)</span><br>SELECT * FROM performance_schema.replication_group_members;<br>12345678910111213141516171819<br><br></code></pre></td></tr></table></figure>

<h5 id="7-3-常用命令及语句"><a href="#7-3-常用命令及语句" class="headerlink" title="7.3 常用命令及语句"></a>7.3 常用命令及语句</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查一下GTID，是否为之前设的那个group的uuid（558edd3c-02ec-11ea-9bb3-080027e39bd2）</span><br>mysql&gt; show master status;<br>+----------------+----------+--------------+------------------+------------------------------------------+<br>| File           | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |<br>+----------------+----------+--------------+------------------+------------------------------------------+<br>| mgr-bin.000004 |     2208 |              |                  | 558edd3c-02ec-11ea-9bb3-080027e39bd2:1-9 |<br>+----------------+----------+--------------+------------------+------------------------------------------+<br><br><span class="hljs-comment"># 查看group内所有成员的节点信息</span><br>mysql&gt; SELECT * FROM performance_schema.replication_group_members;<br>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+<br>| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |<br>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+<br>| group_replication_applier | 4c668095-dd20-11e9-95ba-080027e39bc3 | master2    |        3306 | ONLINE       | SECONDARY   | 8.0.17         |<br>| group_replication_applier | 4c668095-dd20-11e9-95ba-080027e39bd2 | master1    |        3306 | ONLINE       | PRIMARY     | 8.0.17         |<br>| group_replication_applier | c90e9166-de11-11e9-9ee0-080027d8da86 | master3    |        3306 | ONLINE       | SECONDARY   | 8.0.17         |<br>+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+<br><br><span class="hljs-comment"># 查看GROUP中的同步情况,当前复制状态</span><br>mysql&gt; select * from performance_schema.replication_group_member_stats\G;<br>*************************** 1. row ***************************<br>                              CHANNEL_NAME: group_replication_applier<br>                                   VIEW_ID: 15733926047947018:3<br>                                 MEMBER_ID: 4c668095-dd20-11e9-95ba-080027e39bc3<br>               COUNT_TRANSACTIONS_IN_QUEUE: 0<br>                COUNT_TRANSACTIONS_CHECKED: 4<br>                  COUNT_CONFLICTS_DETECTED: 0<br>        COUNT_TRANSACTIONS_ROWS_VALIDATING: 1<br>        TRANSACTIONS_COMMITTED_ALL_MEMBERS: 558edd3c-02ec-11ea-9bb3-080027e39bd2:1-9<br>            LAST_CONFLICT_FREE_TRANSACTION: 558edd3c-02ec-11ea-9bb3-080027e39bd2:9<br>COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE: 0<br>         COUNT_TRANSACTIONS_REMOTE_APPLIED: 5<br>         COUNT_TRANSACTIONS_LOCAL_PROPOSED: 0<br>         COUNT_TRANSACTIONS_LOCAL_ROLLBACK: 0<br>*************************** 2. row ***************************<br>                              CHANNEL_NAME: group_replication_applier<br>                                   VIEW_ID: 15733926047947018:3<br>                                 MEMBER_ID: 4c668095-dd20-11e9-95ba-080027e39bd2<br>               COUNT_TRANSACTIONS_IN_QUEUE: 0<br>                COUNT_TRANSACTIONS_CHECKED: 4<br>                  COUNT_CONFLICTS_DETECTED: 0<br>        COUNT_TRANSACTIONS_ROWS_VALIDATING: 1<br>        TRANSACTIONS_COMMITTED_ALL_MEMBERS: 558edd3c-02ec-11ea-9bb3-080027e39bd2:1-9<br>            LAST_CONFLICT_FREE_TRANSACTION: 558edd3c-02ec-11ea-9bb3-080027e39bd2:9<br>COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE: 0<br>         COUNT_TRANSACTIONS_REMOTE_APPLIED: 2<br>         COUNT_TRANSACTIONS_LOCAL_PROPOSED: 4<br>         COUNT_TRANSACTIONS_LOCAL_ROLLBACK: 0<br>*************************** 3. row ***************************<br>                              CHANNEL_NAME: group_replication_applier<br>                                   VIEW_ID: 15733926047947018:3<br>                                 MEMBER_ID: c90e9166-de11-11e9-9ee0-080027d8da86<br>               COUNT_TRANSACTIONS_IN_QUEUE: 0<br>                COUNT_TRANSACTIONS_CHECKED: 4<br>                  COUNT_CONFLICTS_DETECTED: 0<br>        COUNT_TRANSACTIONS_ROWS_VALIDATING: 1<br>        TRANSACTIONS_COMMITTED_ALL_MEMBERS: 558edd3c-02ec-11ea-9bb3-080027e39bd2:1-9<br>            LAST_CONFLICT_FREE_TRANSACTION: 558edd3c-02ec-11ea-9bb3-080027e39bd2:9<br>COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE: 0<br>         COUNT_TRANSACTIONS_REMOTE_APPLIED: 4<br>         COUNT_TRANSACTIONS_LOCAL_PROPOSED: 0<br>         COUNT_TRANSACTIONS_LOCAL_ROLLBACK: 0<br><br><span class="hljs-comment"># 当前server中各个通道的使用情况</span><br>mysql&gt; select * from performance_schema.replication_connection_status\G;<br>*************************** 1. row ***************************<br>                                      CHANNEL_NAME: group_replication_applier<br>                                        GROUP_NAME: 558edd3c-02ec-11ea-9bb3-080027e39bd2<br>                                       SOURCE_UUID: 558edd3c-02ec-11ea-9bb3-080027e39bd2<br>                                         THREAD_ID: NULL<br>                                     SERVICE_STATE: ON<br>                         COUNT_RECEIVED_HEARTBEATS: 0<br>                          LAST_HEARTBEAT_TIMESTAMP: 0000-00-00 00:00:00.000000<br>                          RECEIVED_TRANSACTION_SET: 558edd3c-02ec-11ea-9bb3-080027e39bd2:1-9<br>                                 LAST_ERROR_NUMBER: 0<br>                                LAST_ERROR_MESSAGE: <br>                              LAST_ERROR_TIMESTAMP: 0000-00-00 00:00:00.000000<br>                           LAST_QUEUED_TRANSACTION: 558edd3c-02ec-11ea-9bb3-080027e39bd2:5<br> LAST_QUEUED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP: 0000-00-00 00:00:00.000000<br>LAST_QUEUED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP: 0000-00-00 00:00:00.000000<br>     LAST_QUEUED_TRANSACTION_START_QUEUE_TIMESTAMP: 2019-11-10 21:35:36.917108<br>       LAST_QUEUED_TRANSACTION_END_QUEUE_TIMESTAMP: 2019-11-10 21:35:36.917146<br>                              QUEUEING_TRANSACTION: <br>    QUEUEING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP: 0000-00-00 00:00:00.000000<br>   QUEUEING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP: 0000-00-00 00:00:00.000000<br>        QUEUEING_TRANSACTION_START_QUEUE_TIMESTAMP: 0000-00-00 00:00:00.000000<br><br><span class="hljs-comment"># 当前server中各个通道是否启用,on是启用</span><br>mysql&gt; select * from performance_schema.replication_applier_status;<br>+---------------------------+---------------+-----------------+----------------------------+<br>| CHANNEL_NAME              | SERVICE_STATE | REMAINING_DELAY | COUNT_TRANSACTIONS_RETRIES |<br>+---------------------------+---------------+-----------------+----------------------------+<br>| group_replication_applier | ON            |            NULL |                          0 |<br>+---------------------------+---------------+-----------------+----------------------------+<br>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394<br><br></code></pre></td></tr></table></figure>

<h4 id="8、故障注意事项"><a href="#8、故障注意事项" class="headerlink" title="8、故障注意事项"></a>8、故障注意事项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 单主模式，恢复MGR-node1节点, 恢复后, 需要手动激活下该节点的组复制功能</span><br><span class="hljs-comment"># 如果节点发生故障, 在恢复后需要重新加入到MGR集群里, 正确的做法是:</span><br>STOP GROUP_REPLICATION;<br>START GROUP_REPLICATION;<br><br><span class="hljs-comment"># 如果某个节点挂了, 则其他的节点继续进行同步。当故障节点恢复后, 只需要手动激活下该节点的组复制功能, 即可正常加入到MGR组复制集群内并自动同步其他节点数据。</span><br>START GROUP_REPLICATION;<br><br><span class="hljs-comment"># 如果是i/o复制出现异常，确定数据无误后</span><br><span class="hljs-comment"># 查找主库的gtid情况</span><br>mysql&gt; show global variables like <span class="hljs-string">&#x27;%gtid%&#x27;</span>;<br>+----------------------------------------------+------------------------------------------+<br>| Variable_name                                | Value                                    |<br>+----------------------------------------------+------------------------------------------+<br>| binlog_gtid_simple_recovery                  | ON                                       |<br>| enforce_gtid_consistency                     | ON                                       |<br>| group_replication_gtid_assignment_block_size | 1000000                                  |<br>| gtid_executed                                | 558edd3c-02ec-11ea-9bb3-080027e39bd2:1-9 |<br>| gtid_executed_compression_period             | 1000                                     |<br>| gtid_mode                                    | ON                                       |<br>| gtid_owned                                   |                                          |<br>| gtid_purged                                  |                                          |<br>| session_track_gtids                          | OFF                                      |<br>+----------------------------------------------+------------------------------------------+<br><br><span class="hljs-comment"># 在有故障的从库中操作</span><br>stop GROUP_REPLICATION;<br>reset master;<br><span class="hljs-built_in">set</span> global gtid_purged=<span class="hljs-string">&#x27;58f6e65e-9309-11e9-9d88-525400184a0a:1-946055:1000003&#x27;</span>;<br>START GROUP_REPLICATION;<br><br><span class="hljs-comment"># 添加白名单网段，一定要注意: 先关闭 Group Replication</span><br>stop group_replication;<br><span class="hljs-built_in">set</span> global group_replication_ip_whitelist=<span class="hljs-string">&quot;127.0.0.1/32,172.16.60.0/24,172.16.50.0/24,172.16.51.0/24&quot;</span>;<br>start group_replication;<br>show variables like <span class="hljs-string">&quot;group_replication_ip_whitelist&quot;</span>;<br></code></pre></td></tr></table></figure>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/mysql/">#mysql</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>mysql8 MGR搭建</div>
      <div>http://example.com/2022/07/11/mysql8-MGR搭建/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Cper Liu</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年7月11日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/11/%E8%AE%B0%E5%BD%95%E5%8E%86%E5%8F%B2/" title="记录历史">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">记录历史</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/10/git%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE/" title="git代理配置">
                        <span class="hidden-mobile">git代理配置</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
