

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Cper Liu">
  <meta name="keywords" content="">
  
    <meta name="description" content="etcd备份恢复原理详解及踩坑实录1. 备份恢复流程  12345678910111213141516171819202122232425262728291. 备份需要使用etcdctl工具：ETCDCTL_API&#x3D;3 etcdctl --endpoints $ENDPOINT snapshot save snapshot.db1恢复时使用etcdutl工具，旧版本的恢复功能也集成在etcdct">
<meta property="og:type" content="article">
<meta property="og:title" content="etcd备份恢复原理详解及踩坑实录">
<meta property="og:url" content="https://liyupin.github.io/2022/11/08/etcd%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3%E5%8F%8A%E8%B8%A9%E5%9D%91%E5%AE%9E%E5%BD%95/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="etcd备份恢复原理详解及踩坑实录1. 备份恢复流程  12345678910111213141516171819202122232425262728291. 备份需要使用etcdctl工具：ETCDCTL_API&#x3D;3 etcdctl --endpoints $ENDPOINT snapshot save snapshot.db1恢复时使用etcdutl工具，旧版本的恢复功能也集成在etcdct">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-11-07T16:44:00.000Z">
<meta property="article:modified_time" content="2022-06-30T18:16:56.708Z">
<meta property="article:author" content="Cper Liu">
<meta property="article:tag" content="etcd">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>etcd备份恢复原理详解及踩坑实录 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"liyupin.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>CPERLYP</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="etcd备份恢复原理详解及踩坑实录"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-11-08 00:44" pubdate>
          2022年11月8日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          65 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">etcd备份恢复原理详解及踩坑实录</h1>
            
            
              <div class="markdown-body">
                
                <hr>
<h1 id="etcd备份恢复原理详解及踩坑实录"><a href="#etcd备份恢复原理详解及踩坑实录" class="headerlink" title="etcd备份恢复原理详解及踩坑实录"></a>etcd备份恢复原理详解及踩坑实录</h1><h2 id="1-备份恢复流程"><a href="#1-备份恢复流程" class="headerlink" title="1. 备份恢复流程"></a>1. 备份恢复流程</h2>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">1. 备份需要使用etcdctl工具：<br><br>ETCDCTL_API=3 etcdctl --endpoints <span class="hljs-variable">$ENDPOINT</span> snapshot save snapshot.db<br>1<br>恢复时使用etcdutl工具，旧版本的恢复功能也集成在etcdctl中，使用如下指令，就可以从snapshot.db文件上恢复起来一个新的etcd集群<br><br>$ etcdutl snapshot restore snapshot.db \<br>  --name m1 \<br>  --initial-cluster m1=http://host1:2380,m2=http://host2:2380,m3=http://host3:2380 \<br>  --initial-cluster-token etcd-cluster-1 \<br>  --initial-advertise-peer-urls http://host1:2380<br>  --data-dir <br>$ etcdutl snapshot restore snapshot.db \<br>  --name m2 \<br>  --initial-cluster m1=http://host1:2380,m2=http://host2:2380,m3=http://host3:2380 \<br>  --initial-cluster-token etcd-cluster-1 \<br>  --initial-advertise-peer-urls http://host2:2380<br>$ etcdutl snapshot restore snapshot.db \<br>  --name m3 \<br>  --initial-cluster m1=http://host1:2380,m2=http://host2:2380,m3=http://host3:2380 \<br>  --initial-cluster-token etcd-cluster-1 \<br>  --initial-advertise-peer-urls http://host3:2380<br><br>name是etcd节点的name，集群中name必须不同<br>initial-cluster是恢复集群的配置<br>initial-cluster-token 会影响计算cluster member <span class="hljs-built_in">id</span>，不是必须的参数<br>initial-advertise-peer-urls节点本身的数据信息<br>data-dir 将备份信息恢复到指定路径<br><br></code></pre></td></tr></table></figure>

<h2 id="2-原理介绍"><a href="#2-原理介绍" class="headerlink" title="2. 原理介绍"></a>2. 原理介绍</h2><h3 id="2-1-备份原理"><a href="#2-1-备份原理" class="headerlink" title="2.1 备份原理"></a>2.1 备份原理</h3><p>etcd server 收到snapshot请求后，将调用backend存储引擎的snapshot接口，获得一份snapshot数据，然后将snapshot数据写入到pipe中，释放掉snapshot（防止长时间ping住snapshot导致过期page无法被释放），后面的发送逻辑会从pipe中读取数据发送回给客户端。</p>
<pre><code class="hljs">func (ms *maintenanceServer) Snapshot(sr *pb.SnapshotRequest, srv pb.Maintenance_SnapshotServer) error &#123;
    snap := ms.bg.Backend().Snapshot()
    pr, pw := io.Pipe()
defer pr.Close()

go func() &#123;
    snap.WriteTo(pw)
    if err := snap.Close(); err != nil &#123;
        ms.lg.Warn(&quot;failed to close snapshot&quot;, zap.Error(err))
    &#125;
    pw.Close()
&#125;()
// 发送snapshot数据
...
...
&#125;
</code></pre>
<p>再来看看backend引擎的snapshot逻辑，先调用了一次事务提交，这个和etcd本身的事务逻辑有关，etcd的已提交事务并不是立即写入到持久化引擎boltdb中的，会先写到backend的缓存中，定期刷到boltdb中，此时要做snapshot，需要先将cache的事务提交到boltdb中，然后调用boltdb的事务接口，创建一个读事务，返回给上层，上层可以通过这个读事务获取到一个snapshot文件。boltdb的后续单独介绍。</p>
<pre><code class="hljs">func (b *backend) Snapshot() Snapshot &#123;
    b.batchTx.Commit()
b.mu.RLock()
defer b.mu.RUnlock()
tx, err := b.db.Begin(false)
if err != nil &#123;
    b.lg.Fatal(&quot;failed to begin tx&quot;, zap.Error(err))
&#125;

stopc, donec := make(chan struct&#123;&#125;), make(chan struct&#123;&#125;)
dbBytes := tx.Size()
...
...
return &amp;snapshot&#123;tx, stopc, donec&#125;
&#125;
</code></pre>
<h3 id="2-2-恢复原理"><a href="#2-2-恢复原理" class="headerlink" title="2.2 恢复原理"></a>2.2 恢复原理</h3><p>恢复的功能是有etcdutl工具独立完成的，核心函数为restore，除去大量的参数校验和准备工作外，最核心的就是剩下的这三个函数。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-comment">// Restore restores a new etcd data directory from given snapshot file.</span><br>func (s *v3Manager) <span class="hljs-keyword">Restore</span>(cfg RestoreConfig) <span class="hljs-keyword">error</span> &#123;<br>	...<br>	...<br>	<span class="hljs-comment">// 清理备份文件中的raft元信息</span><br>	<span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> = s.saveDB(); <span class="hljs-keyword">err</span> != nil &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">err</span><br>	&#125;<br>	<span class="hljs-comment">// 将备份文件恢复为raft启动需要的wal和snapshot文件</span><br>	hardstate, <span class="hljs-keyword">err</span> := s.saveWALAndSnap()<br>	<span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> != nil &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">err</span><br>	&#125;<br>	<span class="hljs-comment">// 更新index信息到boltdb中</span><br>	<span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> := s.updateCIndex(hardstate.Commit, hardstate.Term); <span class="hljs-keyword">err</span> != nil &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">err</span><br>	&#125;<br>	...<br>	...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>咱们一个一个函数看，在saveDB函数中会将备份数据拷贝到对应目录中，然后删除备份数据中的raft元信息。备份恢复的目的是在当前数据集上恢复一个新的raft集群起来，所以只需要备份数据中的用户数据，raft元数据相关的信息直接抹除即可。</p>
<pre><code class="hljs">func (s *v3Manager) saveDB() error &#123;
    // 将备份数据放到对应目录中
    err := s.copyAndVerifyDB()
    if err != nil &#123;
        return err
    &#125;
be := backend.NewDefaultBackend(s.lg, s.outDbPath())
defer be.Close()

// 删除备份数据中的raft元信息
err = schema.NewMembershipBackend(s.lg, be).TrimMembershipFromBackend()
if err != nil &#123;
    return err
&#125;

return nil
&#125;
</code></pre>
<p>来看下一个函数，最终要的过程，如何从备份数据上恢复出来对应的wal文件和snapshot文件。简单来看，这个函数就干了几件事儿：</p>
<p>将新的raft信息写入到boltdb中<br>创建wal并写入node的meta数据，包括node id和cluster id(这个会在后续详细介绍)<br>为准备恢复出的集群中的每个节点配置创建一个raft 配置变更log<br>将日志信息和raft hard state信息写到wal中<br>为当前的状态机（恢复出的数据集）创建一份快照（思考：为什么需要为新集群创建快照呢？启动一个新的raft节点不可以吗？）</p>
<pre><code class="hljs">func (s *v3Manager) saveWALAndSnap() (*raftpb.HardState, error) &#123;
    ...
    ...
    // 将raft信息写入到boltdb中
    for _, m := range s.cl.Members() &#123;
        s.cl.AddMember(m, true)
    &#125;
// 初始化集群的meta信息，nodeID和clusterID，创建wal文件并写入meta信息
m := s.cl.MemberByName(s.name)
md := &amp;etcdserverpb.Metadata&#123;NodeID: uint64(m.ID), ClusterID: uint64(s.cl.ID())&#125;
metadata, merr := md.Marshal()
w, walerr := wal.Create(s.lg, s.walDir, metadata)

// 为每个节点初始化配置变更日志
ents := make([]raftpb.Entry, len(peers))
nodeIDs := make([]uint64, len(peers))
for i, p := range peers &#123;
    nodeIDs[i] = p.ID
    cc := raftpb.ConfChange&#123;
        Type:    raftpb.ConfChangeAddNode,
        NodeID:  p.ID,
        Context: p.Context,
    &#125;
    d, err := cc.Marshal()
    if err != nil &#123;
        return nil, err
    &#125;
    ents[i] = raftpb.Entry&#123;
        Type:  raftpb.EntryConfChange,
        Term:  1,
        Index: uint64(i + 1),
        Data:  d,
    &#125;
&#125;

// 初始化raft 的term和日志提交信息，并保存到hardState中
commit, term := uint64(len(ents)), uint64(1)
hardState := raftpb.HardState&#123;
    Term:   term,
    Vote:   peers[0].ID,
    Commit: commit,
&#125;
// 将日志和hard state持久化到wal中
if err := w.Save(hardState, ents); err != nil &#123;
    return nil, err
&#125;

// 为当前的状态机（恢复出的数据）创建一份raft snapshot，并将对应的snapshot信息写入到wal日志中。
b, berr := st.Save()
if berr != nil &#123;
    return nil, berr
&#125;
confState := raftpb.ConfState&#123;
    Voters: nodeIDs,
&#125;
raftSnap := raftpb.Snapshot&#123;
    Data: b,
    Metadata: raftpb.SnapshotMetadata&#123;
        Index:     commit,
        Term:      term,
        ConfState: confState,
    &#125;,
&#125;
sn := snap.New(s.lg, s.snapDir)
if err := sn.SaveSnap(raftSnap); err != nil &#123;
    return nil, err
&#125;
snapshot := walpb.Snapshot&#123;Index: commit, Term: term, ConfState: &amp;confState&#125;
return &amp;hardState, w.SaveSnapshot(snapshot)
&#125;
</code></pre>
<h3 id="2-3-cluster-member-id"><a href="#2-3-cluster-member-id" class="headerlink" title="2.3 cluster member id"></a>2.3 cluster member id</h3><p>在上述备份恢复的过程中，中间有个步骤会为集群生成一个cluster id。在某些时候错误部署etcd集群后，经常也能看到一个报错信息，“remote cluster member id mismatch”。我们来具体看看这个cluster id到底是什么。根据官网的解释，cluster id是一个集群的标识符，每个集群都有一个cluster id，如果两个节点间的cluster id不一致，说明他们不是一个集群的。下面来看看这个cluster id是怎么生成的</p>
<h4 id="2-3-1-新集群"><a href="#2-3-1-新集群" class="headerlink" title="2.3.1 新集群"></a>2.3.1 新集群</h4><p>新集群的cluster id生成非常简单，直接看代码，首先会根据用户的配置信息生成集群member信息，然后根据集群member信息生成一个hash值作为cluster id，所以多个机器上，以同一个集群配置启动多节点etcd，他们之间的cluster id是一样的，所以他们之间是可以通信并且组成raft集群的。<br>参数中还有个token参数，在创建集群时由–initial-cluster-token参数指定，如不指定会使用默认值，这个参数相当于在hash计算cluster id时加盐，即最终：clusterID &#x3D; hash（集群初始配置… , initial-cluster-token）<br>这个逻辑和上述备份恢复时etcdutl工具的逻辑是一样的，恢复工具也会用参数中的集群配置生成cluster id。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewClusterFromURLsMap</span><span class="hljs-params">(lg *zap.Logger, token <span class="hljs-type">string</span>, urlsmap types.URLsMap, opts ...ClusterOption)</span></span> (*RaftCluster, <span class="hljs-type">error</span>) &#123;<br>	c := NewCluster(lg, opts...)<br>	<span class="hljs-comment">// 根据配置信息初始化集群信息</span><br>	<span class="hljs-keyword">for</span> name, urls := <span class="hljs-keyword">range</span> urlsmap &#123;<br>		...<br>		...<br>		c.members[m.ID] = m<br>	&#125;<br>	<span class="hljs-comment">// 根据集群信息生成一个hash值作为member id</span><br>	c.genID()<br>	<span class="hljs-keyword">return</span> c, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-重启节点"><a href="#2-3-2-重启节点" class="headerlink" title="2.3.2 重启节点"></a>2.3.2 重启节点</h4><p>对于有数据的节点，重启后，不需要重新计算cluster id，直接从wal中读取即可，etcdutl工具对备份数据恢复的过程中也能看到将生成的cluster id写到了wal中。也就是说只有集群初始化才会生成cluster id，一旦生成，不再变更，即使集群节点有配置变更，也不会再影响cluster id。</p>
<p>2.3.3 加入已有集群的节点<br>启动一个节点加入到已有集群中，需要在启动时设着标记位 initial-cluster-state为existing，代码中会判断这个标记位，如果是新加入到集群中的节点会走到如下逻辑中，从远端节点中拉取集群信息，并将cluster id赋值给本地，当然中间有很多校验逻辑，比如比较远端cluster中的配置节点是否和本地的一致。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getClusterFromRemotePeers</span><span class="hljs-params">(lg *zap.Logger, urls []<span class="hljs-type">string</span>, timeout time.Duration, logerr <span class="hljs-type">bool</span>, rt http.RoundTripper)</span></span> (*membership.RaftCluster, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">if</span> lg == <span class="hljs-literal">nil</span> &#123;<br>		lg = zap.NewNop()<br>	&#125;<br>	cc := &amp;http.Client&#123;<br>		Transport: rt,<br>		Timeout:   timeout,<br>	&#125;<br>	<span class="hljs-comment">// 尝试从一个节点获取cluster 配置信息</span><br>	<span class="hljs-keyword">for</span> _, u := <span class="hljs-keyword">range</span> urls &#123;<br>		addr := u + <span class="hljs-string">&quot;/members&quot;</span><br>		resp, err := cc.Get(addr)<br>		...<br>		...<br>		<span class="hljs-comment">//使用远端的cluster 配置初始化本地节点，中间有很多校验逻辑，如果成功，那么会将cluster id赋值给本地节点</span><br>		<span class="hljs-keyword">return</span> membership.NewClusterFromMembers(lg, id, membs), <span class="hljs-literal">nil</span><br>		...<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;could not retrieve cluster information from the given URLs&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="3-踩坑实录，不当备份恢复操作导致etcd数据丢了"><a href="#3-踩坑实录，不当备份恢复操作导致etcd数据丢了" class="headerlink" title="3. 踩坑实录，不当备份恢复操作导致etcd数据丢了"></a>3. 踩坑实录，不当备份恢复操作导致etcd数据丢了</h2><p>  我自己维护了一个3副本的etcd集群，有三个节点分别是e1,e2,e3，因为一些意外，其中e1和e3挂掉了，而且数据文件被破坏了，无法重启这两个进程。然后就开始了修复：</p>
<p>最开始并不了解etcd的member id机制，我想着直接删除e1节点上的数据，将e1当作一个空raft节点重启起来，这之后e1应该能够和e2组成raft两副本，然后恢复集群服务，但是尝试这样做之后，发现e1和e2之间通信都报错“cluster member id mismatch”，后来排查发现，我的集群经历过节点变更，最初的三个节点是e0,e1,e2，后来节点变更变成了,e1,e2,e3，也就是说这个集群的cluster id是hash（e0,e1,e2），而我删除e1数据后，以当前配置启动e1，e1会计算一个新的cluster id，即hash(e1,e2,e3)，所以两边是不match的。<br>无能为力，之后采用备份恢复的方案，先从存活的e2节点上获取了一份snapshot文件，然后对e1进行了备份恢复操作，并将e1重启起来，发现e1和e2通信依然出现cluster id mismatch，原因同上，备份恢复工具使用当前配置计算出的cluster id与e2上的cluster id是不符合的。<br>无奈，将e2也挺掉，然后删除数据文件，走了一遍备份恢复流程后，重新将e2启动起来，这时候e1和e2都能正常通信，形成raft两副本。<br>上述一切都很正常，这时候我就放松警惕了，导致最后一步操作出错了，我将e3的数据文件清理之后，忘记使用备份恢复工具为其恢复数据，就将e3启动起来了，而且此时e3也能正常启动。原因是e3是作为空节点启动，cluster id是使用配置计算得到的，即hash(e1,e2,e3)，这和备份恢复出的e1和e2是一致的，但是e3上数据是空的。<br>集群正常工作一段时间后，因为运维操作将 etcd leader切换到了e3，这时候发现etcd中数据全没了。原因就是e3数据是空的<br>提问：这时候有出现了一个令人疑惑的问题，为什么e3加入了raft集群后，没有从e1或e2上同步数据？raft说好的保证数据强一致呢？<br>回答：raft确实不背这个锅，因为e1和e2也是备份恢复出的节点，从上面恢复逻辑能看到，恢复出来的节点只有几条日志，此时e3启动，从leader节点同步日志，很快就同步完成了，并不能通过install snapshot的操作实现数据同步。除非等待e1和e2运行一段时间，让日志被compact掉，再启动e3，就会触发raft的install snapshot逻辑，最终让e3得到全量的数据。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/k8s/" class="category-chain-item">k8s</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/etcd/">#etcd</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>etcd备份恢复原理详解及踩坑实录</div>
      <div>https://liyupin.github.io/2022/11/08/etcd备份恢复原理详解及踩坑实录/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Cper Liu</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年11月8日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/11/08/docker/" title="dockerbridge-nf-call-iptables is disabled">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">dockerbridge-nf-call-iptables is disabled</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/11/08/fio%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85/" title="fio. gcc.sysstat 离线安装">
                        <span class="hidden-mobile">fio. gcc.sysstat 离线安装</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
